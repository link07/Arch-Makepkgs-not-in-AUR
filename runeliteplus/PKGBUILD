# based off the runelite-git package
pkgname=runeliteplus-git
_pkgname=runelite
pkgver=3270+gcbc07f18c
pkgrel=1
epoch=1
pkgdesc="Open source Old School RuneScape client."
arch=(any)
license=('BSD')
url="https://github.com/runelite-extended/runelite"
# currently fails to compile on openjdk12
depends=('java-environment=8' 'ttf-font')
optdepends=('gvfs: enable links')
makedepends=('gradle' 'java8-openjfx')
provides=("runeliteplus")
source=("git+${url}.git"
		'runeliteplus.desktop'
		'runeliteplus.png::https://rawcdn.githack.com/runelite-extended/runelitepl.us/7949832e9c2ef6d4e4a225950132c20e54f58336/src/assets/icons/icon-512x512.png'
		'runeliteplus.sh')
sha512sums=('SKIP'
			'ced8abfcd9f73e0636139a832cc1b7b93e63937f10ad6fd4cc3439abe68e174501e3503aa7b239e4672386a9f1893305fc6bc2b617290e61b687018099536385'
			'd4afe6d853a1cacd50ea62fc06a05e3659a367a156287e52599af7ff5020427335ae3d83b8a7b170d9af645f6951dce47d5acd1d88d1f440652731becda661fe'
			'c9ac304b111d77a18957267b8bfea6c36681326a02409909ce9bb0a0fda9aa79928055af2aa914847983370a4f4b276acf5c5a1438894354eaf5a6d244138270')

_JAVA_HOME="/usr/lib/jvm/java-8-openjdk"

pkgver() {
	cd "${srcdir}/${_pkgname}"

	# this is how to get the actual version
	# sadly we don't have access to the git repo yet, as it's just been bare-cloned
	#export pkgver=$(grep "version = '" build.gradle | awk '{print $3}' | sed "s/'//g")

	git describe --tags | sed 's/-/+/g' | cut -d '+' -f 3-5
}


build() {
	cd ${srcdir}/${_pkgname}

	# force java 8 to be used
	export JAVA_HOME="$_JAVA_HOME"
	echo "org.gradle.java.home=$_JAVA_HOME" >> gradle.properties

	# we use system gradle instead of gradlew, which would download gradle instead
	# also we do --no-daemon so that we don't leave a daemon process hanging around
    # also don't run tests, they're broken a lot
	gradle build --no-daemon -x test -x:client:checkstyleMain -x:runelite-api:checkstyleMain
}

package() {
	client_jar=$(find ${srcdir}/${_pkgname}/runelite-client/build/libs -type f -name client-*-shaded.jar)

	install -D -m644 \
		"${client_jar}" \
		"${pkgdir}/usr/share/runeliteplus/RuneLite.jar"

	install -D -m644 \
		"${srcdir}/runeliteplus.desktop" \
		"${pkgdir}/usr/share/applications/runeliteplus.desktop"

	install -D -m644 \
		"${srcdir}/runeliteplus.png" \
		"${pkgdir}/usr/share/pixmaps/runeliteplus.png"

	install -D -m644 \
		"${srcdir}/${_pkgname}/LICENSE" \
		"${pkgdir}/usr/share/licenses/${pkgname}"

	install -D -m755 \
		"${srcdir}/runeliteplus.sh" \
		"${pkgdir}/usr/bin/runeliteplus"
}

